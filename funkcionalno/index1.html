<!DOCTYPE html>
<html lang="mk">
<head>
  <meta charset="utf-8" />
  <title>Топоними по држава или Сите</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet/dist/leaflet.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"
  />
  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #controls { padding: 10px; background: #f4f4f4; }
    #map { height: calc(100vh - 50px); }
    .custom-label { font-size: 12px; font-family: Arial; }
  </style>
</head>
<body>

  <div id="controls">
    <label for="countrySelect">Изберете држава:</label>
    <select id="countrySelect">
      <option value="all">— Сите —</option>
    </select>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script>
    // 1) Иницијализирај ја мапата
    const map = L.map('map').setView([42, 21], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);
    const clusters = L.markerClusterGroup().addTo(map);

    // 2) Листа на GeoJSON фајлови
    const countries = {
      "Албанија": "Topo_Albania.geojson",
      "Босна и Херцеговина": "Topo_Bosnia_and_Herzegovina.geojson",
      "Бугарија": "Topo_Bulgaria.geojson",
      "Хрватска": "Topo_Croatia.geojson",
      "Грција": "Topo_Greece.geojson",
      "Унгарија": "Topo_Hungary.geojson",
      "Косово": "Topo_Kosovo.geojson",
      "Црна Гора": "Topo_Monte_Negro.geojson",
      "Северна Македонија": "Topo_North_Macedonia.geojson",
      "Романија": "Topo_Romania.geojson",
      "Србија": "Topo_Serbia.geojson",
      "Словенија": "Topo_Slovenia.geojson"
    };

    // 3) Пополнување на dropdown
    const select = document.getElementById('countrySelect');
    for (let name in countries) {
      const opt = document.createElement('option');
      opt.value = countries[name];
      opt.text  = name;
      select.add(opt);
    }

    // 4) Функција за вчитување (по држава или сите)
    function loadCountry(file) {
      clusters.clearLayers();
      const files = (file === 'all') 
        ? Object.values(countries) 
        : [file];

      files.forEach( fname => {
        fetch(fname)
          .then(r => {
            if (!r.ok) throw new Error(r.statusText);
            return r.json();
          })
          .then(json => {
            L.geoJSON(json, {
              pointToLayer: (f, latlng) =>
                L.circleMarker(latlng, {
                  radius: 5,
                  fillColor: 'red',
                  color: '#000',
                  weight: 1,
                  fillOpacity: 0.8
              }),
              onEachFeature: (f, layer) => {
                const name = f.properties.name || '[n/a]';
                const first3 = name.slice(0,3),
                      rest   = name.slice(3);
                const tt = `<span style="color:red;"><b>${first3}</b></span>` +
                           `<span style="color:black;">${rest}</span>`;
                layer.bindTooltip(tt, {
                  permanent: true,
                  direction: 'top',
                  className: 'custom-label'
                });
                layer.bindPopup(`<b>${name}</b><br>Тип: ${f.properties.place || '–'}`);
              }
            }).addTo(clusters);
          })
          .catch(err => {
            console.error("Грешка при вчитување на", fname, err);
          });
      });

      // Кога сите слоеви се додадени, фокусирај ја мапата
      setTimeout(() => {
        if (clusters.getLayers().length) {
          map.fitBounds(clusters.getBounds(), { maxZoom: 10 });
        }
      }, 500);
    }

    // 5) Событие на селекција и стартно вчитување
    select.addEventListener('change', () => loadCountry(select.value));
    select.selectedIndex = 0;             // „all“ на врв
    loadCountry(select.value);            // вчита сите прво
  </script>
</body>
</html>
