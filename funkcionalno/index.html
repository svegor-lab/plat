<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TOCABA – Toponymic Cartography of the Balkans</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet/dist/leaflet.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"
  />
  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #header { padding: 10px; background: #2c3e50; color: white; text-align: center; }
    #controls { padding: 10px; background: #ecf0f1; }
    #map { height: calc(100vh - 100px); }
    .custom-label { font-size: 12px; font-family: Arial; }
  </style>
</head>
<body>
  <div id="header">
    <h1>TOCABA – Toponymic Cartography of the Balkans</h1>
  </div>
  <div id="controls">
    <label for="countrySelect">Select Country:</label>
    <select id="countrySelect">
      <option value="all">— All —</option>
    </select>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script>
    // Initialize map
    const map = L.map('map').setView([42, 21], 6);

    // Base layers
    const baseOSM = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    const baseSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/' +
      'World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles &copy; Esri'
    });

    const baseTerrain = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}.jpg', {
      subdomains: 'abcd',
      attribution: 'Map tiles by Stamen Design, under CC BY 3.0'
    });

    const baseLayers = {
      "OSM": baseOSM,
      "Satellite": baseSat,
      "Terrain": baseTerrain
    };
    L.control.layers(baseLayers).addTo(map);

    // Marker cluster group
    const clusters = L.markerClusterGroup().addTo(map);

    // Country GeoJSON files
    const countries = {
      "Albania": "Topo_Albania.geojson",
      "Bosnia and Herzegovina": "Topo_Bosnia_and_Herzegovina.geojson",
      "Bulgaria": "Topo_Bulgaria.geojson",
      "Croatia": "Topo_Croatia.geojson",
      "Greece": "Topo_Greece.geojson",
      "Hungary": "Topo_Hungary.geojson",
      "Kosovo": "Topo_Kosovo.geojson",
      "Montenegro": "Topo_Monte_Negro.geojson",
      "North Macedonia": "Topo_North_Macedonia.geojson",
      "Romania": "Topo_Romania.geojson",
      "Serbia": "Topo_Serbia.geojson",
      "Slovenia": "Topo_Slovenia.geojson"
    };

    // Populate dropdown
    const select = document.getElementById('countrySelect');
    for (let name in countries) {
      const opt = document.createElement('option');
      opt.value = countries[name];
      opt.text = name;
      select.add(opt);
    }

    // Load country or all
    function loadCountry(file) {
      clusters.clearLayers();
      const files = (file === 'all') ? Object.values(countries) : [file];

      files.forEach(fname => {
        fetch(fname)
          .then(r => {
            if (!r.ok) throw new Error(r.statusText);
            return r.json();
          })
          .then(json => {
            L.geoJSON(json, {
              pointToLayer: (f, latlng) => L.circleMarker(latlng, {
                radius: 5,
                fillColor: 'red',
                color: '#000',
                weight: 1,
                fillOpacity: 0.8
              }),
              onEachFeature: (f, layer) => {
                const name = f.properties.name || '[n/a]';
                const first3 = name.slice(0,3), rest = name.slice(3);
                const tt = `<span style="color:red;"><b>${first3}</b></span>` +
                           `<span style="color:black;">${rest}</span>`;
                layer.bindTooltip(tt, { permanent: true, direction: 'top', className: 'custom-label' });
                layer.bindPopup(`<strong>${name}</strong><br>Type: ${f.properties.place || '–'}`);
              }
            }).addTo(clusters);
          })
          .catch(err => console.error('Error loading', fname, err));
      });

      setTimeout(() => {
        if (clusters.getLayers().length) {
          map.fitBounds(clusters.getBounds(), { maxZoom: 12 });
        }
      }, 500);
    }

    // Event and initial load
    select.addEventListener('change', () => loadCountry(select.value));
    select.selectedIndex = 0;
    loadCountry(select.value);
  </script>
</body>
</html>
