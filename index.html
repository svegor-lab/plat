<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TOCABA – Toponymic Cartography of the Balkans</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <style>
    body { margin:0; font-family:Arial,sans-serif; }
    #header { padding:10px; background:#2c3e50; color:white; text-align:center; }
    #controls { padding:10px; background:#ecf0f1; display:flex; flex-wrap:wrap; align-items:flex-start; gap:10px; }
    #map { height:calc(100vh - 180px); }
    .filter-group { display:flex; flex-direction:column; gap:4px; }
    .legend { background:white; padding:6px; line-height:1.5; }
    .legend i { width:12px; height:12px; float:left; margin-right:4px; opacity:0.8; }
    #stats { margin-left:auto; text-align:right; }
    .hidden { display: none; }
    button {
      padding: 6px 12px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #2980b9;
    }
  </style>
</head>
<body>
  <div id="header"><h1>TOCABA – Toponymic Cartography of the Balkans</h1></div>
  <div id="controls">
    <label for="countrySelect">Country:</label>
    <select id="countrySelect"><option value="all">— All —</option></select>

    <label for="searchInput">Search:</label>
    <input type="text" id="searchInput" placeholder="Name...">

    <button onclick="toggleSuffixFilters()">Филтри по суфикси ⬇</button>

    <div class="filter-group hidden" id="suffixFilters">
      <strong>Македонски:</strong>
      <label><input type="checkbox" value="ва"> -ва</label>
      <label><input type="checkbox" value="ен"> -ен</label>
      <label><input type="checkbox" value="ец"> -ец</label>
      <label><input type="checkbox" value="еп"> -еп/-ош/-аш</label>
      <label><input type="checkbox" value="и"> -и</label>
      <label><input type="checkbox" value="ија"> -ија</label>
      <label><input type="checkbox" value="ино"> -ино</label>
      <label><input type="checkbox" value="инци"> -инци</label>
      <label><input type="checkbox" value="ка"> -ка</label>
      <label><input type="checkbox" value="ица"> -ица</label>
      <label><input type="checkbox" value="ич"> -ич</label>
      <label><input type="checkbox" value="иште"> -иште</label>
      <label><input type="checkbox" value="ште"> -ште/-шите/-шита</label>
      <label><input type="checkbox" value="јак"> -јак</label>
      <label><input type="checkbox" value="јани"> -јани</label>
      <label><input type="checkbox" value="је"> -је</label>
      <label><input type="checkbox" value="ник"> -ник</label>
      <label><input type="checkbox" value="ница"> -ница</label>
      <label><input type="checkbox" value="ово"> -ово</label>
      <label><input type="checkbox" value="овци"> -овци/-евци</label>
      <label><input type="checkbox" value="от"> -от</label>
      <label><input type="checkbox" value="ско"> -ско/-шко/-чко</label>
      <label><input type="checkbox" value="ци"> -ци</label>
      <label><input type="checkbox" value="че"> -че</label>
      <label><input type="checkbox" value="чка"> -чка</label>
      <label><input type="checkbox" value="штица"> -штица</label>

      <strong>Турски:</strong>
      <label><input type="checkbox" value="џик"> -џик</label>
      <label><input type="checkbox" value="ли"> -ли</label>
      <label><input type="checkbox" value="лија"> -лија</label>

      <strong>Влашки:</strong>
      <label><input type="checkbox" value="арди"> -арди</label>
      <label><input type="checkbox" value="лај"> -лај</label>

      <strong>Непознати:</strong>
      <label><input type="checkbox" value="ле"> -ле</label>
      <label><input type="checkbox" value="ок"> -ок</label>
    </div>

    <div class="filter-group">
      <button id="exportGeo">Export GeoJSON</button>
      <button id="exportCSV">Export CSV</button>
    </div>

    <div id="stats"><strong>Statistics:</strong> Loading...</div>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script>
    const map = L.map('map').setView([42, 21], 6);
    const OSM = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OSM' }).addTo(map);
    const SAT = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri' });
    const TER = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}.jpg', { subdomains: 'abcd', attribution: 'Stamen' });
    L.control.layers({ OSM, Satellite: SAT, Terrain: TER }).addTo(map);

    const clusters = L.markerClusterGroup().addTo(map);
    const legend = L.control({ position: 'bottomright' });
    legend.onAdd = () => {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = '<i style="background:red"></i> Toponyms';
      return div;
    };
    legend.addTo(map);

    const files = {
      "Albania": "Topo_Albania.geojson",
      "Bosnia": "Topo_Bosnia_and_Herzegovina.geojson",
      "Bulgaria": "Topo_Bulgaria.geojson",
      "Croatia": "Topo_Croatia.geojson",
      "Greece": "Topo_Greece.geojson",
      "Hungary": "Topo_Hungary.geojson",
      "Kosovo": "Topo_Kosovo.geojson",
      "Montenegro": "Topo_Monte_Negro.geojson",
      "North Macedonia": "Topo_North_Macedonia.geojson",
      "Romania": "Topo_Romania.geojson",
      "Serbia": "Topo_Serbia.geojson",
      "Slovenia": "Topo_Slovenia.geojson"
    };

    const select = document.getElementById('countrySelect');
    const suffixCB = [...document.querySelectorAll('#suffixFilters input')];
    const searchInput = document.getElementById('searchInput');
    const exportGeo = document.getElementById('exportGeo');
    const exportCSV = document.getElementById('exportCSV');
    const statsDiv = document.getElementById('stats');

    Object.keys(files).forEach(k => {
      const o = document.createElement('option');
      o.value = files[k];
      o.text = k;
      select.add(o);
    });

    let lastFeatures = [];

    function toggleSuffixFilters() {
      const box = document.getElementById('suffixFilters');
      box.classList.toggle('hidden');
    }

    function highlightSuffix(name, suffixes) {
      const nameLower = name.toLowerCase();
      const match = suffixes.find(sfx => nameLower.endsWith(sfx));
      if (!match) return name;
      const i = nameLower.lastIndexOf(match);
      return name.slice(0, i) + '<span style="color:red">' + name.slice(i) + '</span>';
    }

    async function loadCountry(file) {
      clusters.clearLayers();
      lastFeatures = [];
      const arr = file === 'all' ? Object.values(files) : [file];
      const term = searchInput.value.toLowerCase();
      const suffixes = suffixCB.filter(cb => cb.checked).map(cb => cb.value.toLowerCase());
      let dataAll = [];

      for (const f of arr) {
        const r = await fetch(f);
        if (!r.ok) continue;
        const j = await r.json();
        dataAll = dataAll.concat(j.features);
      }

      const filtered = dataAll.filter(ft => {
        const n = (ft.properties.name || '').toLowerCase();
        const okTerm = !term || n.includes(term);
        const okSuf = suffixes.length === 0 || suffixes.some(sfx => n.endsWith(sfx));
        return okTerm && okSuf;
      });

      lastFeatures = filtered;
      statsDiv.innerHTML = `<strong>Statistics:</strong> Total: ${filtered.length}`;

      filtered.forEach(ft => {
        const lat = ft.geometry.coordinates[1];
        const lng = ft.geometry.coordinates[0];
        const n = ft.properties.name || '';
        const label = highlightSuffix(n, suffixes);
        const c = L.circleMarker([lat, lng], {
          radius: 5, fillColor: 'red', color: '#000', weight: 1, fillOpacity: 0.8
        });
        c.bindTooltip(label, { permanent: true, direction: 'top', className: 'custom-label' });

        let popupHTML = '';
        for (const [key, value] of Object.entries(ft.properties)) {
          popupHTML += `<strong>${key}:</strong> ${value}<br>`;
        }
        c.bindPopup(popupHTML);
        clusters.addLayer(c);
      });

      map.fitBounds(clusters.getBounds(), { maxZoom: 12 });
    }

    exportGeo.onclick = () => {
      const fc = { type: 'FeatureCollection', features: lastFeatures };
      const blob = new Blob([JSON.stringify(fc)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'export.geojson';
      a.click();
    };

    exportCSV.onclick = () => {
      const rows = ['name,lat,lng,place'];
      lastFeatures.forEach(ft => {
        rows.push(`"${ft.properties.name}",${ft.geometry.coordinates[1]},${ft.geometry.coordinates[0]},${ft.properties.place || ''}`);
      });
      const blob = new Blob([rows.join('\n')], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'export.csv';
      a.click();
    };

    [select, ...suffixCB].forEach(el => el.addEventListener('change', () => loadCountry(select.value)));
    searchInput.addEventListener('input', () => loadCountry(select.value));

    select.selectedIndex = 0;
    loadCountry(select.value);
  </script>
</body>
</html>
