<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>TOCABA – Toponymic Cartography of the Balkans</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>
  <style>
    body{margin:0}
    header{background:#2c3e50;color:#fff;padding:6px 12px;text-align:center;font-size:15px}
    /* Sidebar */
    #sidebar{
      position:fixed;top:0;left:0;width:260px;height:100vh;background:#f8f9fa;border-right:1px solid #ddd;
      padding:14px;overflow-y:auto;z-index:1100;transform:translateX(-270px);transition:.25s;
    }
    #sidebar.show{transform:translateX(0)}
    #toggleBtn{
      position:fixed;top:44px;left:10px;z-index:1200;background:#0d6efd;border:none;color:#fff;padding:7px 12px;border-radius:4px
    }
    /* Map */
    #map{height:calc(100vh - 32px);margin-top:32px}
    /* Force zoom to right */
    .leaflet-top.leaflet-left{display:none!important;}
    .leaflet-top.leaflet-right{top:60px;right:14px}
    /* Suffix list grid */
    #suffixList{display:grid;grid-template-columns:1fr 1fr;gap:4px;max-height:240px;overflow-y:auto}
    #suffixList .form-check{margin-bottom:2px}
  </style>
</head>
<body>
<header>TOCABA – Toponymic Cartography of the Balkans</header>
<button id="toggleBtn">☰</button>

<div id="sidebar" class="show"><!-- оставен отворен по default -->
  <div class="d-grid gap-2 mb-2">
    <button id="refreshBtn" class="btn btn-warning">Refresh</button>
  </div>

  <div class="accordion" id="acc">
    <!-- Countries & Search -->
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button" data-bs-toggle="collapse" data-bs-target="#acc1">Countries & Search</button>
      </h2>
      <div id="acc1" class="accordion-collapse collapse show">
        <div class="accordion-body">
          <select id="countrySelect" class="form-select mb-2"><option value="all">— All —</option></select>
          <input id="searchInput" class="form-control" placeholder="Search...">
        </div>
      </div>
    </div>

    <!-- Morphostructures (grouped) -->
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#acc2">Morphostructures</button>
      </h2>
      <div id="acc2" class="accordion-collapse collapse">
        <div class="accordion-body">
          <label class="form-label">Group</label>
          <select id="groupSelect" class="form-select mb-2">
            <option value="all">All</option>
            <option value="mk">Macedonian</option>
            <option value="tr">Turkish</option>
            <option value="ar">Aromanian</option>
            <option value="un">Unknown</option>
          </select>
          <div id="suffixList"></div>
        </div>
      </div>
    </div>

    <!-- Substratum quick (checkboxes stay here if ти требаат) -->
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#acc3">Substratum</button>
      </h2>
      <div id="acc3" class="accordion-collapse collapse">
        <div class="accordion-body">
          <div class="text-muted">Turkish</div>
          <div class="form-check"><input class="form-check-input" type="checkbox" value="џик"><label class="form-check-label">-џик</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" value="ли"><label class="form-check-label">-ли</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" value="лија"><label class="form-check-label">-лија</label></div>

          <div class="mt-2 text-muted">Aromanian</div>
          <div class="form-check"><input class="form-check-input" type="checkbox" value="арди"><label class="form-check-label">-арди</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" value="лај"><label class="form-check-label">-лај</label></div>

          <div class="mt-2 text-muted">Unknown</div>
          <div class="form-check"><input class="form-check-input" type="checkbox" value="ле"><label class="form-check-label">-ле</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" value="ок"><label class="form-check-label">-ок</label></div>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#acc4">Actions</button>
      </h2>
      <div id="acc4" class="accordion-collapse collapse">
        <div class="accordion-body">
          <button id="exportGeo" class="btn btn-outline-primary mb-2 w-100">Export GeoJSON</button>
          <button id="exportCSV" class="btn btn-outline-success w-100">Export CSV</button>
          <div id="stats" class="small text-muted mt-2">Statistics: …</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="map"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script>
/* ----- UI basics ----- */
const sidebar = document.getElementById('sidebar');
document.getElementById('toggleBtn').onclick = () => sidebar.classList.toggle('show');

/* ----- Map ----- */
const map = L.map('map').setView([42,21], 7);
const OSM = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OSM'}).addTo(map);
const SAT = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{attribution:'Esri'});
L.control.layers({OSM, Satellite: SAT}, {}, {position:'topright'}).addTo(map);

/* Force zoom to right */
map.zoomControl.remove();
L.control.zoom({position:'topright'}).addTo(map);

const clusters = L.markerClusterGroup().addTo(map);

/* ----- Files (остави ги geojson-ите во ист фолдер) ----- */
const files = {
 "Albania":"Topo_Albania.geojson","Bosnia":"Topo_Bosnia_and_Herzegovina.geojson","Bulgaria":"Topo_Bulgaria.geojson",
 "Croatia":"Topo_Croatia.geojson","Greece":"Topo_Greece.geojson","Hungary":"Topo_Hungary.geojson",
 "Kosovo":"Topo_Kosovo.geojson","Montenegro":"Topo_Monte_Negro.geojson","North Macedonia":"Topo_North_Macedonia.geojson",
 "Romania":"Topo_Romania.geojson","Serbia":"Topo_Serbia.geojson","Slovenia":"Topo_Slovenia.geojson"
};

/* Populate countries */
const sel = document.getElementById('countrySelect');
for (const k in files){ const o=document.createElement('option'); o.value=files[k]; o.text=k; sel.add(o); }

/* Search & filters */
const search = document.getElementById('searchInput');
const stats  = document.getElementById('stats');
const exportGeo = document.getElementById('exportGeo');
const exportCSV = document.getElementById('exportCSV');
const refreshBtn = document.getElementById('refreshBtn');
let lastFeatures = [];

/* ----- GROUPED morphostructures ----- */
const groupSelect = document.getElementById('groupSelect');
const suffixList  = document.getElementById('suffixList');

/* lists (точно како што бараше) */
const SUF_MK = ["ва","ен","ец","еп","и","ија","ино","инци","ка","ица","ич","иште","ште","јак","јани","је","ник","ница","ово","овци","от","ско","ци","че","чка","штица"];
// забелешка: "еп/-ош/-аш" → вредност "еп" ќе ја фатаме, а во tooltip ќе покажеме целиот запис.
const SUF_TR = ["џик","ли","лија"];
const SUF_AR = ["арди","лај"];
const SUF_UN = ["ле","ок"];

function renderSuffixes(){
  const g = groupSelect.value;
  let items = [];
  if (g === 'all') items = [
    ...SUF_MK.map(s=>({v:s, lbl:s})),
    ...SUF_TR.map(s=>({v:s, lbl:s})),
    ...SUF_AR.map(s=>({v:s, lbl:s})),
    ...SUF_UN.map(s=>({v:s, lbl:s}))
  ];
  else if (g === 'mk') items = SUF_MK.map(s=>({v:s,lbl:s}));
  else if (g === 'tr') items = SUF_TR.map(s=>({v:s,lbl:s}));
  else if (g === 'ar') items = SUF_AR.map(s=>({v:s,lbl:s}));
  else if (g === 'un') items = SUF_UN.map(s=>({v:s,lbl:s}));

  suffixList.innerHTML = '';
  items.forEach(({v,lbl})=>{
    const div = document.createElement('div'); div.className='form-check';
    const inp = document.createElement('input'); inp.type='checkbox'; inp.className='form-check-input'; inp.value=v;
    const lab = document.createElement('label'); lab.className='form-check-label'; lab.textContent = '-'+lbl;
    div.appendChild(inp); div.appendChild(lab); suffixList.appendChild(div);
    inp.addEventListener('change', () => loadCountry(sel.value)); // НЕ затвораме sidebar
  });
}
groupSelect.addEventListener('change', renderSuffixes);
renderSuffixes();

/* Utility: highlight suffix */
function highlightSuffix(name, suffixes){
  const nl=name.toLowerCase();
  const m = suffixes.find(s => nl.endsWith(s));
  if (!m) return name;
  const i = nl.lastIndexOf(m);
  return name.slice(0,i) + '<span style="color:red">' + name.slice(i) + '</span>';
}

async function loadCountry(file){
  clusters.clearLayers(); lastFeatures = [];
  const term = search.value.toLowerCase();
  const chosenSuffixes = [...suffixList.querySelectorAll('input:checked')].map(i=>i.value.toLowerCase());
  const arr = (file==='all') ? Object.values(files) : [file];

  let data = [];
  for (const f of arr){ const r = await fetch(f); if (r.ok){ const j = await r.json(); data = data.concat(j.features);} }

  const filtered = data.filter(ft=>{
    const n=(ft.properties.name||'').toLowerCase();
    const okTerm = !term || n.includes(term);
    const okSuf  = chosenSuffixes.length===0 || chosenSuffixes.some(s=>n.endsWith(s));
    return okTerm && okSuf;
  });

  lastFeatures = filtered;
  stats.textContent = `Statistics: ${filtered.length}`;

  filtered.forEach(ft=>{
    const [lng,lat]=ft.geometry.coordinates;
    const name = ft.properties.name || '';
    const label = highlightSuffix(name, chosenSuffixes);
    const c=L.circleMarker([lat,lng],{radius:5,fillColor:'red',color:'#000',weight:1,fillOpacity:.8});
    let pop=''; for (const[k,v] of Object.entries(ft.properties)){ pop+=`<strong>${k}:</strong> ${v}<br>`; }
    c.bindTooltip(label,{permanent:true,direction:'top'}).bindPopup(pop);
    clusters.addLayer(c);
  });

  if (filtered.length) map.fitBounds(clusters.getBounds(),{maxZoom:12});
}

/* Events (без auto-close на sidebar) */
sel.addEventListener('change', () => loadCountry(sel.value));
search.addEventListener('input', () => loadCountry(sel.value));
refreshBtn.addEventListener('click', () => loadCountry(sel.value));

/* Exports */
exportGeo.onclick=()=>{const b=new Blob([JSON.stringify({type:'FeatureCollection',features:lastFeatures})],{type:'application/json'});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download='export.geojson';a.click();}
exportCSV.onclick=()=>{const rows=['name,lat,lng,place'];lastFeatures.forEach(ft=>rows.push(`"${ft.properties.name}",${ft.geometry.coordinates[1]},${ft.geometry.coordinates[0]},${ft.properties.place||''}`));const b=new Blob([rows.join('\n')],{type:'text/csv'});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download='export.csv';a.click();}

/* Init */
sel.value='all'; loadCountry('all');
</script>
</body>
</html>
